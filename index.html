// === LÓGICA DE COMPRAS POR PERÍODO (CORRIGIDA) ===
        window.gerarListaCompras = async () => {
            const dInicio = document.getElementById('dataInicio').value;
            const dFim = document.getElementById('dataFim').value;

            if(!dInicio || !dFim) return alert("Selecione a data de Início e Fim!");
            if(dInicio > dFim) return alert("A data de início não pode ser maior que a final.");

            const div = document.getElementById('ml-conteudo');
            div.innerHTML = '<p class="text-center text-slate-400">Somando tudo...</p>';
            document.getElementById('modalLista').classList.remove('hidden');
            
            const dataFmtIni = dInicio.split('-').reverse().join('/');
            const dataFmtFim = dFim.split('-').reverse().join('/');
            document.getElementById('ml-data').innerText = `${dataFmtIni} até ${dataFmtFim}`;

            // Busca Vendas >= dataInicio e <= dataFim
            const snap = await db.collection("transacoes")
                .where("tipo", "==", "VENDA")
                .where("data", ">=", dInicio)
                .where("data", "<=", dFim)
                .get();

            if(snap.empty) {
                div.innerHTML = '<p class="text-center text-slate-400 py-10">Nenhuma venda neste período.</p>';
                return;
            }

            // AQUI ESTAVA O ERRO: Garantimos que listaFinal comece VAZIA sempre
            let listaFinal = {}; 

            snap.forEach(doc => {
                const venda = doc.data();
                const itensStr = venda.descricao.split(', '); 
                
                itensStr.forEach(itemStr => {
                    const partes = itemStr.split('x ');
                    if(partes.length < 2) return;
                    const qtdVenda = parseInt(partes[0]);
                    const nomeKit = partes[1].trim();

                    if(RECEITAS[nomeKit]) {
                        // Se é KIT, explode os ingredientes
                        for (const [ingrediente, qtdReceita] of Object.entries(RECEITAS[nomeKit])) {
                            if(!listaFinal[ingrediente]) listaFinal[ingrediente] = 0;
                            listaFinal[ingrediente] += (qtdReceita * qtdVenda);
                        }
                    } else {
                        // Se é item avulso ou kit sem receita cadastrada
                        if(!listaFinal[nomeKit]) listaFinal[nomeKit] = 0;
                        listaFinal[nomeKit] += qtdVenda;
                    }
                });
            });

            // Limpa a tela antes de desenhar
            div.innerHTML = '';
            
            const listaOrdenada = Object.entries(listaFinal).sort((a,b) => a[0].localeCompare(b[0]));
            
            if(listaOrdenada.length === 0) { 
                div.innerHTML = '<p class="text-center text-slate-400">Não consegui identificar itens.</p>'; 
                return; 
            }

            listaOrdenada.forEach(([nome, qtd]) => {
                div.innerHTML += `
                <div class="flex justify-between items-center p-3 bg-white border border-slate-100 rounded-xl">
                    <span class="font-bold text-slate-700">${nome}</span>
                    <span class="font-bold text-brand-600 bg-sky-50 px-3 py-1 rounded-lg text-lg">${qtd}</span>
                </div>`;
            });
        };
